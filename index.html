<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Invoice Processor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-file-invoice"></i>
                <span>InvoicePro</span>
            </div>
            <nav>
                <ul>
                    <li class="active"><a href="#upload-section"><i class="fas fa-upload"></i> Process Invoice</a></li>
                    <li><a href="#invoices-section"><i class="fas fa-list"></i> Invoice Records</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <span class="username">Admin User</span>
                    <span class="role">Administrator</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="header-title">
                    <h1 id="page-title">Invoice Processor</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="new-invoice-btn">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Upload/Process Section -->
                <section id="upload-section" class="content-section active">
                    <div class="section-header">
                        <h2><i class="fas fa-file-import"></i> Process New Invoice</h2>
                        <p>Upload a PDF invoice to extract and process data</p>
                    </div>

                    <div class="upload-area" id="drop-zone">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Upload Invoice PDF</h3>
                            <p>Drag & drop your invoice file here or click to browse</p>
                            <input type="file" id="pdf-upload" accept="application/pdf" style="display: none;">
                            <button class="btn btn-outline" id="browse-btn">Select File</button>
                        </div>
                        <div id="upload-status" class="status-message"></div>
                    </div>

                    <div id="document-info" class="document-info">
                        <strong>Current Document:</strong> <span id="current-filename">None</span>
                    </div>

                    <div class="processing-container">
                        <div class="document-viewer-container">
                            <div class="tab-container">
                                <div class="tab active" data-tab="viewer">Document Viewer</div>
                                <div class="tab" data-tab="select">Text Selection</div>
                                <div class="tab" data-tab="extracted">Extracted Text</div>
                                <div class="tab" data-tab="fields">Detected Fields</div>
                            </div>

                            <div class="tab-content active" id="viewer-tab">
                                <div id="pdf-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="zoom-level">100%</span>
                                    </div>
                                    <div id="pdf-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>

                            <div class="tab-content" id="select-tab">
                                <div id="pdf-select-container">
                                    <div class="zoom-controls">
                                        <button class="zoom-btn" id="select-zoom-in"><i class="fas fa-search-plus"></i></button>
                                        <button class="zoom-btn" id="select-zoom-out"><i class="fas fa-search-minus"></i></button>
                                        <span id="select-zoom-level">100%</span>
                                    </div>
                                    <div id="pdf-select-viewer"></div>
                                </div>
                                <div class="page-controls">
                                    <button class="page-btn" id="select-prev-page"><i class="fas fa-chevron-left"></i> Previous</button>
                                    <span id="select-page-info">Page 1 of 1</span>
                                    <button class="page-btn" id="select-next-page">Next <i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="info-text">
                                    <p>Select text from the document and drag to form fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="fields-tab">
                                <div class="text-content" id="fields-content">
                                    <p>Upload a document to see detected fields</p>
                                </div>
                            </div>

                            <div class="tab-content" id="extracted-tab">
                                <div class="extracted-text-container">
                                    <div class="extracted-text-content" id="extracted-text-content">
                                        <p>Upload a document to see extracted text</p>
                                    </div>
                                </div>
                                <div class="info-text">
                                    <p>Click and drag any text to form fields</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-header">
                                <h3><i class="fas fa-file-alt"></i> Invoice Details</h3>
                                <p>Review and edit extracted information</p>
                            </div>
                            <form id="invoice-form">
                                <div id="form-fields-container">
                                    <div class="form-group">
                                        <label for="invoice-number" class="form-label">Invoice Number *</label>
                                        <div class="drop-area" id="invoice-number-drop" data-field="invoice-number">
                                            <input type="text" id="invoice-number" name="invoice-number" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" required>
                                        </div>
                                        <p class="info-text">Look for "Invoice Number:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="po-number" class="form-label">PO Number</label>
                                        <div class="drop-area" id="po-number-drop" data-field="po-number">
                                            <input type="text" id="po-number" name="po-number" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off">
                                        </div>
                                        <p class="info-text">Look for "PO Number:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="invoice-date" class="form-label">Invoice Date</label>
                                        <div class="drop-area" id="invoice-date-drop" data-field="invoice-date">
                                            <input type="date" id="invoice-date" name="invoice-date" class="form-control">
                                        </div>
                                        <p class="info-text">Look for "Invoice Date:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="payment-terms" class="form-label">Payment Terms</label>
                                        <div class="drop-area" id="payment-terms-drop" data-field="payment-terms">
                                            <input type="text" id="payment-terms" name="payment-terms" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off">
                                        </div>
                                        <p class="info-text">Look for "Payment Terms:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="total-amount" class="form-label">Total Amount *</label>
                                        <div class="drop-area" id="total-amount-drop" data-field="total-amount">
                                            <input type="text" id="total-amount" name="total-amount" class="form-control" 
                                                   placeholder="Will auto-fill from document" autocomplete="off" required>
                                        </div>
                                        <p class="info-text">Look for "Total Amount:" in the document</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Vendor Information</label>
                                        <div class="drop-area" id="vendor-info-drop" data-field="vendor-info">
                                            <textarea id="vendor-info" name="vendor-info" class="form-control" rows="3" 
                                                      placeholder="Vendor details will auto-fill" autocomplete="off"></textarea>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Invoice Items</label>
                                        <div class="drop-area" id="invoice-items-drop">
                                            <div class="invoice-items-container" id="invoice-items-container">
                                                <!-- Items will be added here dynamically -->
                                            </div>
                                            <button type="button" class="add-item-btn" id="add-item-btn">
                                                <i class="fas fa-plus"></i> Add Item
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-footer">
                                    <button type="submit" class="btn btn-primary btn-block" id="save-btn">
                                        <i class="fas fa-save"></i> Save Invoice
                                    </button>
                                    <div id="form-status" class="status-message"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Invoices Table Section -->
                <section id="invoices-section" class="content-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Invoice Records</h2>
                        <p>View and manage all processed invoices</p>
                    </div>

                    <div class="table-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="invoice-search" placeholder="Search invoices...">
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-outline" id="refresh-invoices">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="invoices-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>PO #</th>
                                    <th>Date</th>
                                    <th>Vendor</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded from server -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invoice Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="invoice-detail-content">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // Global variables
        let pdfDocument = null;
        let currentPage = 1;
        let selectPage = 1;
        let scale = 1.0;
        let selectScale = 1.0;
        let extractedText = [];
        let detectedFields = {};
        let allTextItems = [];
        let activeInput = null;
        let textLayer = null;
        let selectTextLayer = null;
        let selectedTextSpan = null;
        let isDraggingFromSelect = false;
        let invoicesTable = null;
        
        // DOM elements
        const browseBtn = document.getElementById('browse-btn');
        const pdfUpload = document.getElementById('pdf-upload');
        const dropZone = document.getElementById('drop-zone');
        const uploadStatus = document.getElementById('upload-status');
        const currentFilename = document.getElementById('current-filename');
        const documentInfo = document.getElementById('document-info');
        const zoomLevel = document.getElementById('zoom-level');
        const selectZoomLevel = document.getElementById('select-zoom-level');
        const addItemBtn = document.getElementById('add-item-btn');
        const formFieldsContainer = document.getElementById('form-fields-container');
        const extractedTextContent = document.getElementById('extracted-text-content');
        const newInvoiceBtn = document.getElementById('new-invoice-btn');
        const refreshInvoicesBtn = document.getElementById('refresh-invoices');
        const invoiceSearch = document.getElementById('invoice-search');
        const saveBtn = document.getElementById('save-btn');
        const formStatus = document.getElementById('form-status');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateZoomDisplay();
            initializeDataTable();
            loadInvoices();
            
            // Set active section based on hash
            if (window.location.hash) {
                showSection(window.location.hash);
            }
        });
        
        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('href'));
                });
            });
            
            // New invoice button
            newInvoiceBtn.addEventListener('click', function() {
                showSection('#upload-section');
                resetForm();
            });
            
            // Refresh invoices button
            refreshInvoicesBtn.addEventListener('click', loadInvoices);
            
            // Search input
            invoiceSearch.addEventListener('input', function() {
                if (invoicesTable) {
                    invoicesTable.search(this.value).draw();
                }
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // Browse button click handler
            browseBtn.addEventListener('click', function() {
                pdfUpload.click();
            });
            
            // File input change handler
            pdfUpload.addEventListener('change', handleFileSelect);
            
            // Drag and drop handlers
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    pdfUpload.files = e.dataTransfer.files;
                    handleFileSelect({ target: pdfUpload });
                }
            });
            
            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', function() { zoomIn('viewer'); });
            document.getElementById('zoom-out').addEventListener('click', function() { zoomOut('viewer'); });
            document.getElementById('select-zoom-in').addEventListener('click', function() { zoomIn('select'); });
            document.getElementById('select-zoom-out').addEventListener('click', function() { zoomOut('select'); });
            
            // Page navigation
            document.getElementById('prev-page').addEventListener('click', function() { goToPrevPage('viewer'); });
            document.getElementById('next-page').addEventListener('click', function() { goToNextPage('viewer'); });
            document.getElementById('select-prev-page').addEventListener('click', function() { goToPrevPage('select'); });
            document.getElementById('select-next-page').addEventListener('click', function() { goToNextPage('select'); });
            
            // Add item button
            addItemBtn.addEventListener('click', addInvoiceItem);
            
            // Form submission
            document.getElementById('invoice-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInvoice();
            });
            
            // Setup drag and drop for form fields
            document.querySelectorAll('.drop-area').forEach(dropArea => {
                dropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('highlight');
                    e.dataTransfer.dropEffect = 'copy';
                });
                
                dropArea.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });
                
                dropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    const text = e.dataTransfer.getData('text/plain');
                    const fieldId = this.dataset.field;
                    
                    if (text) {
                        if (fieldId) {
                            const input = document.getElementById(fieldId);
                            if (input) {
                                input.value = text;
                                
                                // Show visual feedback
                                this.classList.add('field-match');
                                setTimeout(() => {
                                    this.classList.remove('field-match');
                                }, 1000);
                            }
                        } else if (this.id === 'invoice-items-drop') {
                            // Handle drop on invoice items container
                            const activeItemField = document.querySelector('.item-card input:focus');
                            if (activeItemField) {
                                activeItemField.value = text;
                            }
                        }
                    }
                });
            });
            
            // Document mouse events for text selection
            document.addEventListener('mousedown', function(e) {
                if (e.target.closest('#pdf-select-viewer span') || e.target.closest('#extracted-text-content span')) {
                    isDraggingFromSelect = true;
                    selectedTextSpan = e.target.closest('span');
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDraggingFromSelect = false;
            });
            
            // Setup drag events for extracted text
            extractedTextContent.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'SPAN') {
                    e.target.classList.add('selected');
                    selectedTextSpan = e.target;
                }
            });
            
            extractedTextContent.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'SPAN') {
                    e.dataTransfer.setData('text/plain', e.target.textContent);
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
        }
        
        // Show section based on hash
        function showSection(sectionId) {
            // Update URL hash
            window.location.hash = sectionId;
            
            // Update page title
            const titleMap = {
                '#upload-section': 'Process Invoice',
                '#invoices-section': 'Invoice Records'
            };
            document.getElementById('page-title').textContent = titleMap[sectionId] || 'Invoice Processor';
            
            // Update active section
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelector(sectionId).classList.add('active');
            
            // Update active nav link
            document.querySelectorAll('.sidebar nav li').forEach(li => {
                li.classList.remove('active');
            });
            document.querySelector(`.sidebar nav a[href="${sectionId}"]`).parentElement.classList.add('active');
        }
        
        // Initialize DataTable
        function initializeDataTable() {
            invoicesTable = $('#invoices-table').DataTable({
                ajax: {
                    url: '/api/invoices',
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'invoice_number' },
                    { data: 'po_number' },
                    { 
                        data: 'invoice_date',
                        render: function(data) {
                            return data ? moment(data).format('MMM D, YYYY') : 'N/A';
                        }
                    },
                    { 
                        data: 'vendor_info',
                        render: function(data) {
                            return data ? data.split('\n')[0] : 'N/A';
                        }
                    },
                    { 
                        data: 'total_amount',
                        render: function(data) {
                            return data ? '$' + parseFloat(data).toFixed(2) : '$0.00';
                        }
                    },
                    { 
                        data: 'created_at',
                        render: function() {
                            return '<span class="status-badge status-processed">Processed</span>';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data) {
                            return `
                                <div class="action-buttons">
                                    <button class="btn-action view-invoice" data-id="${data}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action delete-invoice" data-id="${data}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        },
                        orderable: false
                    }
                ],
                order: [[2, 'desc']],
                responsive: true
            });
            
            // Handle view invoice click
            $('#invoices-table').on('click', '.view-invoice', function() {
                const invoiceId = $(this).data('id');
                viewInvoiceDetails(invoiceId);
            });
            
            // Handle delete invoice click
            $('#invoices-table').on('click', '.delete-invoice', function() {
                const invoiceId = $(this).data('id');
                deleteInvoice(invoiceId);
            });
        }
        
        // Load invoices from server
        function loadInvoices() {
            showLoading(true);
            fetch('/api/invoices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (invoicesTable) {
                        invoicesTable.ajax.reload(null, false);
                    }
                })
                .catch(error => {
                    console.error('Error loading invoices:', error);
                    showStatus('Error loading invoices', 'error', uploadStatus);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // View invoice details
        function viewInvoiceDetails(invoiceId) {
            showLoading(true);
            fetch(`/api/invoices/${invoiceId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load invoice details');
                    }
                    
                    // Format the invoice details
                    let itemsHtml = '';
                    if (data.data.items && data.data.items.length > 0) {
                        itemsHtml = `
                            <h4>Items</h4>
                            <table class="invoice-items-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.items.map(item => `
                                        <tr>
                                            <td>${item.description || 'N/A'}</td>
                                            <td>${item.quantity || 'N/A'}</td>
                                            <td>$${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                                            <td>$${parseFloat(item.total || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                    
                    const html = `
                        <div class="invoice-detail-header">
                            <div>
                                <h4>Invoice #${data.data.invoice_number || 'N/A'}</h4>
                                <p class="invoice-date">${data.data.invoice_date ? moment(data.data.invoice_date).format('MMMM D, YYYY') : 'N/A'}</p>
                            </div>
                            <div class="invoice-total">
                                <span>Total Amount</span>
                                <h3>$${parseFloat(data.data.total_amount || 0).toFixed(2)}</h3>
                            </div>
                        </div>
                        
                        <div class="invoice-detail-info">
                            <div>
                                <h5>Vendor Information</h5>
                                <p>${data.data.vendor_info ? data.data.vendor_info.replace(/\n/g, '<br>') : 'N/A'}</p>
                            </div>
                            <div>
                                <h5>Payment Terms</h5>
                                <p>${data.data.payment_terms || 'Not specified'}</p>
                                
                                <h5>PO Number</h5>
                                <p>${data.data.po_number || 'Not specified'}</p>
                            </div>
                        </div>
                        
                        ${itemsHtml}
                    `;
                    
                    document.getElementById('invoice-detail-content').innerHTML = html;
                    document.getElementById('invoice-detail-modal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading invoice details:', error);
                    showStatus('Error loading invoice details', 'error', uploadStatus);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                showLoading(true);
                fetch(`/api/invoices/${invoiceId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showStatus('Invoice deleted successfully', 'success', uploadStatus);
                        loadInvoices();
                    } else {
                        throw new Error(data.error || 'Failed to delete invoice');
                    }
                })
                .catch(error => {
                    console.error('Error deleting invoice:', error);
                    showStatus('Error deleting invoice', 'error', uploadStatus);
                })
                .finally(() => {
                    showLoading(false);
                });
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('invoice-detail-modal').style.display = 'none';
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showStatus('Please upload a PDF file', 'error', uploadStatus);
                return;
            }
            
            currentFilename.textContent = file.name;
            documentInfo.style.display = 'block';
            
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                showStatus('Processing document...', 'success', uploadStatus);
                
                // Load the PDF
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    pdfDocument = pdf;
                    showStatus('Document loaded successfully!', 'success', uploadStatus);
                    
                    // Reset state
                    currentPage = 1;
                    selectPage = 1;
                    scale = 1.0;
                    selectScale = 1.0;
                    extractedText = [];
                    detectedFields = {};
                    allTextItems = [];
                    
                    // Clear previous content
                    document.getElementById('pdf-viewer').innerHTML = '';
                    document.getElementById('pdf-select-viewer').innerHTML = '';
                    document.getElementById('fields-content').innerHTML = '';
                    document.getElementById('invoice-items-container').innerHTML = '';
                    extractedTextContent.innerHTML = '';
                    
                    // Render the pages
                    renderPage(currentPage, 'viewer');
                    renderPage(selectPage, 'select');
                    
                    // Extract text from all pages
                    extractTextFromPDF(pdf);
                    
                    // Update page info
                    updatePageInfo('viewer');
                    updatePageInfo('select');
                    updateZoomDisplay();
                }).catch(function(error) {
                    showStatus('Error loading PDF: ' + error.message, 'error', uploadStatus);
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        // Render PDF page with selectable text layer
        function renderPage(pageNum, type = 'viewer') {
            if (!pdfDocument) return;
            
            const viewerId = type === 'viewer' ? 'pdf-viewer' : 'pdf-select-viewer';
            const currentScale = type === 'viewer' ? scale : selectScale;
            
            pdfDocument.getPage(pageNum).then(function(page) {
                const viewport = page.getViewport({ scale: currentScale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Clear previous content
                const viewer = document.getElementById(viewerId);
                viewer.innerHTML = '';
                viewer.appendChild(canvas);
                
                // Render PDF page
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(function() {
                    // Create text layer for selection
                    return page.getTextContent().then(function(textContent) {
                        const textLayerDiv = document.createElement('div');
                        textLayerDiv.className = 'text-layer';
                        
                        // Create text layer divs
                        pdfjsLib.renderTextLayer({
                            textContent: textContent,
                            container: textLayerDiv,
                            viewport: viewport,
                            textDivs: []
                        });
                        
                        viewer.appendChild(textLayerDiv);
                        
                        if (type === 'select') {
                            selectTextLayer = textLayerDiv;
                        } else {
                            textLayer = textLayerDiv;
                        }
                        
                        // Make text selectable and draggable
                        const textSpans = textLayerDiv.querySelectorAll('span');
                        textSpans.forEach(span => {
                            span.draggable = true;
                            
                            span.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', this.textContent);
                                e.dataTransfer.effectAllowed = 'copy';
                            });
                            
                            span.addEventListener('click', function() {
                                if (selectedTextSpan) {
                                    selectedTextSpan.classList.remove('selected');
                                }
                                this.classList.add('selected');
                                selectedTextSpan = this;
                            });
                        });
                    });
                });
            });
        }
        
        // Extract text from PDF
        function extractTextFromPDF(pdf) {
            extractedText = [];
            detectedFields = {};
            allTextItems = [];
            const numPages = pdf.numPages;
            let promises = [];
            
            for (let i = 1; i <= numPages; i++) {
                promises.push(
                    pdf.getPage(i).then(function(page) {
                        return page.getTextContent().then(function(textContent) {
                            let pageText = '';
                            let pageItems = [];
                            let formattedText = '';
                            
                            textContent.items.forEach(function(textItem) {
                                const text = textItem.str.trim();
                                if (text) {
                                    pageText += text + ' ';
                                    pageItems.push({
                                        text: text,
                                        transform: textItem.transform,
                                        page: i
                                    });
                                    allTextItems.push(text);
                                    
                                    // Create formatted text with spans for selection
                                    formattedText += `<span draggable="true">${text}</span> `;
                                }
                                
                                // Add line breaks based on y-position changes
                                if (textItem.hasEOL) {
                                    formattedText += '\n';
                                }
                            });
                            
                            extractedText.push({
                                page: i,
                                text: pageText,
                                formattedText: formattedText,
                                items: pageItems
                            });
                            
                            // Detect fields in this page's text
                            detectFields(pageText, pageItems);
                        });
                    })
                );
            }
            
            Promise.all(promises).then(function() {
                console.log('Text extraction complete');
                
                // Display extracted text
                displayExtractedText();
                
                // Display detected fields
                displayDetectedFields();
                
                // Auto-fill form
                autoFillForm();
            });
        }
        
        // Display extracted text with formatting
        function displayExtractedText() {
            extractedTextContent.innerHTML = '';
            
            extractedText.forEach(page => {
                const pageHeader = document.createElement('div');
                pageHeader.style.fontWeight = 'bold';
                pageHeader.style.margin = '10px 0 5px 0';
                pageHeader.textContent = `Page ${page.page}:`;
                extractedTextContent.appendChild(pageHeader);
                
                const pageContent = document.createElement('div');
                pageContent.innerHTML = page.formattedText;
                extractedTextContent.appendChild(pageContent);
                
                // Add drag events to the spans
                pageContent.querySelectorAll('span').forEach(span => {
                    span.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', this.textContent);
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                    
                    span.addEventListener('click', function() {
                        if (selectedTextSpan) {
                            selectedTextSpan.classList.remove('selected');
                        }
                        this.classList.add('selected');
                        selectedTextSpan = this;
                    });
                });
            });
        }
        
        // Detect fields in text
        function detectFields(text, textItems) {
            // Common field patterns
            const fieldPatterns = {
                'invoice-number': /(Invoice\s*Number|Invoice\s*No\.?)\s*[:#]?\s*([A-Z0-9-]+)/i,
                'po-number': /(PO\s*Number|Purchase\s*Order|Order\s*No\.?)\s*[:#]?\s*([A-Z0-9-]+)/i,
                'invoice-date': /(Invoice\s*Date|Date\s*of\s*Invoice)\s*[:]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/i,
                'payment-terms': /(Payment\s*Terms)\s*[:]?\s*(Net\s*\d+\s*[^\n]*)/i,
                'total-amount': /(Total\s*Amount|Amount\s*Due|Grand\s*Total)\s*[:]?\s*([$\u20AC\u00A3]?\s*[\d,]+\.?\d*)/i,
                'vendor-info': /From:\s*([\s\S]*?)(?=To:)/i
            };

            // Enhanced payment terms detection
            if (!detectedFields['payment-terms']) {
                const paymentTermsMatch = text.match(/(?:Payment\s*Terms)\s*[:]?\s*(Net\s*15)/i);
                if (paymentTermsMatch) {
                    detectedFields['payment-terms'] = {
                        value: paymentTermsMatch[1].trim(),
                        confidence: 'high',
                        rawText: paymentTermsMatch[0]
                    };
                } else {
                    // Fallback to finding payment terms in the footer
                    const paymentFooterMatch = text.match(/Please\s*make\s*payment\s*within\s*(\d+)\s*days/i);
                    if (paymentFooterMatch) {
                        detectedFields['payment-terms'] = {
                            value: `Net ${paymentFooterMatch[1]}`,
                            confidence: 'medium',
                            rawText: paymentFooterMatch[0]
                        };
                    }
                }
            }

            // Detect table data with improved pattern
            const tablePattern = /Description\s*Quantity\s*Unit\s*Price\s*Total[\s\S]*?(?=Subtotal|Total|GST)/i;
            const tableMatch = text.match(tablePattern);
            if (tableMatch) {
                detectedFields['invoice-items'] = {
                    value: tableMatch[0],
                    confidence: 'high',
                    rawText: tableMatch[0]
                };
            }
            
            // Check for each field pattern
            for (const [field, pattern] of Object.entries(fieldPatterns)) {
                const match = text.match(pattern);
                if (match && !detectedFields[field]) {
                    detectedFields[field] = {
                        value: match[2] || match[1],
                        confidence: 'high',
                        rawText: match[0]
                    };
                }
            }
            
            // Additional vendor info detection
            if (!detectedFields['vendor-info']) {
                const vendorMatch = text.match(/(?:From|Supplier|Vendor):\s*([\s\S]*?)(?:\n\s*\n|\n\s*[A-Z][a-z])/i);
                if (vendorMatch) {
                    detectedFields['vendor-info'] = {
                        value: vendorMatch[1].trim(),
                        confidence: 'medium',
                        rawText: vendorMatch[0]
                    };
                }
            }
        }
        
        // Auto-fill form with detected fields
        function autoFillForm() {
            for (const [field, data] of Object.entries(detectedFields)) {
                const element = document.getElementById(field);
                if (!element) continue;
                
                if (field === 'invoice-items') {
                    parseTableData(data.rawText);
                } else if (field.endsWith('-date')) {
                    element.value = normalizeDate(data.value);
                } else {
                    element.value = data.value;
                }
                
                // Highlight the drop area to show it was auto-filled
                const dropArea = document.getElementById(`${field}-drop`);
                if (dropArea) {
                    dropArea.classList.add('field-match');
                    setTimeout(() => {
                        dropArea.classList.remove('field-match');
                    }, 2000);
                }
            }
        }
        
        // Parse table data from text with improved method
        function parseTableData(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            // Find the table data section
            let startIndex = lines.findIndex(line => 
                line.includes('Description') && 
                line.includes('Quantity') && 
                line.includes('Unit Price') && 
                line.includes('Total')
            );
            
            if (startIndex === -1) return;
            
            // Process each line after the header
            for (let i = startIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                
                // Skip lines that look like headers or totals
                if (line.match(/Description|Quantity|Unit Price|Total|Subtotal|GST|Total Amount/i)) {
                    continue;
                }
                
                // Split by multiple spaces (simple approach)
                const parts = line.split(/\s{2,}/).filter(part => part.trim() !== '');
                
                if (parts.length >= 4) {
                    addInvoiceItem({
                        description: parts[0].trim(),
                        quantity: parts[1].trim(),
                        unitPrice: parts[2].trim(),
                        total: parts[3].trim()
                    });
                }
            }
        }
        
        // Add an invoice item card
        function addInvoiceItem(data = {}) {
            const container = document.getElementById('invoice-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            
            itemDiv.innerHTML = `
                <div class="item-field">
                    <label>Description</label>
                    <input type="text" value="${data.description || ''}" class="item-description">
                </div>
                <div class="item-field">
                    <label>Quantity</label>
                    <input type="text" value="${data.quantity || ''}" class="item-quantity">
                </div>
                <div class="item-field">
                    <label>Unit Price</label>
                    <input type="text" value="${data.unitPrice || ''}" class="item-unit-price">
                </div>
                <div class="item-field">
                    <label>Total</label>
                    <input type="text" value="${data.total || ''}" class="item-total">
                </div>
                <button type="button" class="remove-item-btn"><i class="fas fa-times"></i></button>
            `;
            
            // Add remove button handler
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', function() {
                itemDiv.remove();
            });
            
            // Make inputs draggable targets
            itemDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                });
                
                input.addEventListener('dragleave', function() {
                    this.parentElement.style.backgroundColor = '';
                });
                
                input.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.parentElement.style.backgroundColor = '';
                    const text = e.dataTransfer.getData('text/plain');
                    if (text) {
                        this.value = text;
                    }
                });
            });
            
            container.appendChild(itemDiv);
        }
        
        // Normalize date format for input[type=date]
        function normalizeDate(dateStr) {
            // Simple date format conversion
            const parts = dateStr.split(/[\/\-]/);
            if (parts.length === 3) {
                if (parts[0].length === 4) { // YYYY-MM-DD
                    return dateStr;
                } else { // MM/DD/YYYY or DD-MM-YYYY
                    if (parts[2].length === 2) parts[2] = '20' + parts[2];
                    return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                }
            }
            return dateStr;
        }
        
        // Display detected fields
        function displayDetectedFields() {
            const fieldsContent = document.getElementById('fields-content');
            fieldsContent.innerHTML = '';
            
            if (Object.keys(detectedFields).length === 0) {
                fieldsContent.innerHTML = '<p>No fields detected automatically. Please use drag and drop.</p>';
                return;
            }
            
            const fieldsList = document.createElement('ul');
            fieldsList.style.listStyleType = 'none';
            fieldsList.style.padding = '0';
            
            for (const [field, data] of Object.entries(detectedFields)) {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '10px';
                listItem.style.padding = '10px';
                listItem.style.backgroundColor = '#f0f0f0';
                listItem.style.borderRadius = '4px';
                
                const fieldName = document.createElement('strong');
                fieldName.textContent = field.replace('-', ' ') + ': ';
                fieldName.style.textTransform = 'capitalize';
                
                const fieldValue = document.createElement('span');
                fieldValue.textContent = data.value;
                
                const confidence = document.createElement('span');
                confidence.textContent = ` (${data.confidence} confidence)`;
                confidence.style.color = data.confidence === 'high' ? 'var(--success-color)' : 'var(--dark-gray)';
                confidence.style.fontSize = '0.8em';
                confidence.style.marginLeft = '5px';
                
                listItem.appendChild(fieldName);
                listItem.appendChild(fieldValue);
                listItem.appendChild(confidence);
                fieldsList.appendChild(listItem);
            }
            
            fieldsContent.appendChild(fieldsList);
        }
        
        // Zoom functions
        function zoomIn(type) {
            if (type === 'viewer') {
                if (scale < 3.0) {
                    scale += 0.25;
                    renderPage(currentPage, 'viewer');
                    updateZoomDisplay();
                }
            } else {
                if (selectScale < 3.0) {
                    selectScale += 0.25;
                    renderPage(selectPage, 'select');
                    updateZoomDisplay();
                }
            }
        }
        
        function zoomOut(type) {
            if (type === 'viewer') {
                if (scale > 0.5) {
                    scale -= 0.25;
                    renderPage(currentPage, 'viewer');
                    updateZoomDisplay();
                }
            } else {
                if (selectScale > 0.5) {
                    selectScale -= 0.25;
                    renderPage(selectPage, 'select');
                    updateZoomDisplay();
                }
            }
        }
        
        function updateZoomDisplay() {
            zoomLevel.textContent = `${Math.round(scale * 100)}%`;
            selectZoomLevel.textContent = `${Math.round(selectScale * 100)}%`;
        }
        
        // Page navigation
        function goToPrevPage(type) {
            if (type === 'viewer') {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage(currentPage, 'viewer');
                    updatePageInfo('viewer');
                }
            } else {
                if (selectPage > 1) {
                    selectPage--;
                    renderPage(selectPage, 'select');
                    updatePageInfo('select');
                }
            }
        }
        
        function goToNextPage(type) {
            if (type === 'viewer') {
                if (pdfDocument && currentPage < pdfDocument.numPages) {
                    currentPage++;
                    renderPage(currentPage, 'viewer');
                    updatePageInfo('viewer');
                }
            } else {
                if (pdfDocument && selectPage < pdfDocument.numPages) {
                    selectPage++;
                    renderPage(selectPage, 'select');
                    updatePageInfo('select');
                }
            }
        }
        
        // Update page info display
        function updatePageInfo(type) {
            if (pdfDocument) {
                if (type === 'viewer') {
                    document.getElementById('page-info').textContent = 
                        `Page ${currentPage} of ${pdfDocument.numPages}`;
                } else {
                    document.getElementById('select-page-info').textContent = 
                        `Page ${selectPage} of ${pdfDocument.numPages}`;
                }
            }
        }
        
        // Save invoice to database
        function saveInvoice() {
            // Validate form
            const invoiceNumber = document.getElementById('invoice-number').value;
            const totalAmount = document.getElementById('total-amount').value;
            
            if (!invoiceNumber || !totalAmount) {
                showStatus('Invoice Number and Total Amount are required fields', 'error', formStatus);
                return;
            }
            
            if (isNaN(parseFloat(totalAmount))) {
                showStatus('Total Amount must be a valid number', 'error', formStatus);
                return;
            }
            
            // Collect form data
            const formData = {
                invoiceNumber: invoiceNumber,
                poNumber: document.getElementById('po-number').value,
                invoiceDate: document.getElementById('invoice-date').value,
                paymentTerms: document.getElementById('payment-terms').value,
                totalAmount: totalAmount,
                vendorInfo: document.getElementById('vendor-info').value,
                items: []
            };
            
            // Collect invoice items
            document.querySelectorAll('.item-card').forEach(item => {
                formData.items.push({
                    description: item.querySelector('.item-description').value,
                    quantity: item.querySelector('.item-quantity').value,
                    unitPrice: item.querySelector('.item-unit-price').value,
                    total: item.querySelector('.item-total').value
                });
            });
            
            // Show loading state
            showLoading(true);
            saveBtn.disabled = true;
            
            // Send data to server
            fetch('/api/invoices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showStatus('Invoice saved successfully!', 'success', formStatus);
                    resetForm();
                    loadInvoices();
                    showSection('#invoices-section');
                } else {
                    throw new Error(data.error || 'Failed to save invoice');
                }
            })
            .catch(error => {
                console.error('Error saving invoice:', error);
                showStatus('Error saving invoice: ' + error.message, 'error', formStatus);
            })
            .finally(() => {
                showLoading(false);
                saveBtn.disabled = false;
            });
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('invoice-form').reset();
            document.getElementById('invoice-items-container').innerHTML = '';
            document.getElementById('current-filename').textContent = 'None';
            documentInfo.style.display = 'none';
            
            // Clear PDF viewer
            if (pdfDocument) {
                document.getElementById('pdf-viewer').innerHTML = '';
                document.getElementById('pdf-select-viewer').innerHTML = '';
                pdfDocument = null;
            }
            
            // Reset page info
            document.getElementById('page-info').textContent = 'Page 1 of 1';
            document.getElementById('select-page-info').textContent = 'Page 1 of 1';
            
            // Clear extracted text and fields
            document.getElementById('fields-content').innerHTML = '';
            document.getElementById('extracted-text-content').innerHTML = '';
        }
        
        // Show status message
        function showStatus(message, type, element) {
            element.textContent = message;
            element.className = 'status-message ' + type;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.textContent = '';
                    element.className = 'status-message';
                }, 5000);
            }
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            spinner.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>